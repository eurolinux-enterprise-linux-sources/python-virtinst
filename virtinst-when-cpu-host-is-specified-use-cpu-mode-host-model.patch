From b45fa1c9dc7978589249442fa029e555a08da0a8 Mon Sep 17 00:00:00 2001
From: Amador Pahim <asegundo@redhat.com>
Date: Mon, 23 Feb 2015 14:02:26 +0100
Subject: [PATCH 1/3] when --cpu=host is specified use cpu mode='host-model'

Closes: https://bugzilla.redhat.com/show_bug.cgi?id=1167072

RHEL-only

Signed-off-by: Giuseppe Scrivano <gscrivan@redhat.com>
---
 virtinst/CPU.py | 18 ++++++++++++++++--
 virtinst/cli.py |  2 +-
 2 files changed, 17 insertions(+), 3 deletions(-)

diff --git a/virtinst/CPU.py b/virtinst/CPU.py
index 6ada5bc..3cbd187 100644
--- a/virtinst/CPU.py
+++ b/virtinst/CPU.py
@@ -78,6 +78,7 @@ class CPU(XMLBuilderDomain.XMLBuilderDomain):
     MATCHS = ["minimum", "exact", "strict"]
 
     def __init__(self, conn, parsexml=None, parsexmlnode=None, caps=None):
+        self._mode = None
         self._model = None
         self._match = None
         self._vendor = None
@@ -127,6 +128,13 @@ class CPU(XMLBuilderDomain.XMLBuilderDomain):
         self._features.remove(feature)
 
 
+    def _get_mode(self):
+        return self._mode
+    def _set_mode(self, val):
+        self._mode = val
+    mode = _xml_property(_get_mode, _set_mode,
+                         xpath="./cpu/@mode")
+
     def _get_model(self):
         return self._model
     def _set_model(self, val):
@@ -175,6 +183,9 @@ class CPU(XMLBuilderDomain.XMLBuilderDomain):
                             get_converter=lambda s, x: _int_or_none(x),
                             xpath="./cpu/topology/@threads")
 
+    def use_host_model(self):
+        self.mode = "host-model"
+
     def copy_host_cpu(self):
         """
         Enact the equivalent of qemu -cpu host, pulling all info
@@ -261,16 +272,19 @@ class CPU(XMLBuilderDomain.XMLBuilderDomain):
     def _get_xml_config(self):
         top_xml = self._get_topology_xml()
         feature_xml = self._get_feature_xml()
+        mode_xml = ""
+        if self.mode:
+            mode_xml = " mode='%s'" % self.mode
         match_xml = ""
         if self.match:
             match_xml = " match='%s'" % self.match
         xml = ""
 
-        if not (self.model or top_xml or feature_xml):
+        if not (self.mode or self.model or top_xml or feature_xml):
             return ""
 
         # Simple topology XML mode
-        xml += "  <cpu%s>\n" % match_xml
+        xml += "  <cpu%s%s>\n" % (mode_xml, match_xml)
         if self.model:
             xml += "    <model>%s</model>\n" % self.model
         if self.vendor:
diff --git a/virtinst/cli.py b/virtinst/cli.py
index 5a27017..43ae73f 100644
--- a/virtinst/cli.py
+++ b/virtinst/cli.py
@@ -1314,7 +1314,7 @@ def parse_cpu(guest, optstring):
         del(opts[policy])
 
     if opts.get("model") == "host":
-        guest.cpu.copy_host_cpu()
+        guest.cpu.use_host_model()
         del(opts["model"])
 
     set_param("model", "model")
-- 
2.1.0

