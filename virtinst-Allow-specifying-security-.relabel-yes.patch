commit d6268d78fb1ebd1983d6b3fbfd3db0b1f6942d92
Author: Cole Robinson <crobinso@redhat.com>
Date:   Mon Sep 26 11:58:43 2011 -0400

    virt-install: Allow specifying --security ...relabel=yes|no
    
    To tell libvirt to auto apply a manually passed label

diff --git a/man/en/virt-install.pod.in b/man/en/virt-install.pod.in
index 7a036de..4351c11 100644
--- a/man/en/virt-install.pod.in
+++ b/man/en/virt-install.pod.in
@@ -172,11 +172,12 @@ may cause issues if migrating the guest to a host without an identical CPU.
 Human readable text description of the virtual machine. This will be stored
 in the guests XML configuration for access by other applications.
 
-=item --security type=TYPE[,label=LABEL]
+=item --security type=TYPE[,label=LABEL][,relabel=yes|no]
 
 Configure domain security driver settings. Type can be either 'static' or
 'dynamic'. 'static' configuration requires a security LABEL. Specifying
-LABEL without TYPE implies static configuration.
+LABEL without TYPE implies static configuration. To have libvirt automatically
+apply your static label, you must specify relabel=yes.
 
 =back
 
diff --git a/virtinst/Seclabel.py b/virtinst/Seclabel.py
index 45e8849..2035578 100644
--- a/virtinst/Seclabel.py
+++ b/virtinst/Seclabel.py
@@ -41,6 +41,7 @@ class Seclabel(XMLBuilderDomain.XMLBuilderDomain):
         self._model = None
         self._label = None
         self._imagelabel = None
+        self._relabel = None
 
         if self._is_parse():
             return
@@ -76,6 +77,13 @@ class Seclabel(XMLBuilderDomain.XMLBuilderDomain):
     label = _xml_property(get_label, set_label,
                           xpath="./seclabel/label")
 
+    def _get_relabel(self):
+        return self._label
+    def _set_relabel(self, val):
+        self._label = val
+    relabel = _xml_property(_get_relabel, _set_relabel,
+                            xpath="./seclabel/@relabel")
+
     def get_imagelabel(self):
         return self._imagelabel
     def set_imagelabel(self, val):
@@ -90,6 +98,7 @@ class Seclabel(XMLBuilderDomain.XMLBuilderDomain):
 
         model = self.model
         typ = self.type
+        relabel = self.relabel
 
         if model == self.MODEL_DEFAULT:
             model = self._get_default_model()
@@ -99,13 +108,16 @@ class Seclabel(XMLBuilderDomain.XMLBuilderDomain):
         if not typ:
             raise RuntimeError("Security type and model must be specified")
 
-        if (typ == self.SECLABEL_TYPE_STATIC and not self.label):
-            raise RuntimeError("A label must be specified for static "
-                               "security type.")
+        if typ == self.SECLABEL_TYPE_STATIC:
+            if not self.label:
+                raise RuntimeError("A label must be specified for static "
+                                   "security type.")
 
 
         label_xml = ""
         xml = "  <seclabel type='%s' model='%s'" % (typ, model)
+        if relabel is not None:
+            xml += " relabel='%s'" % (relabel and "yes" or "no")
 
         if self.label:
             label_xml += "    <label>%s</label>\n" % self.label
diff --git a/virtinst/cli.py b/virtinst/cli.py
index 14ecbe7..a8cd101 100644
--- a/virtinst/cli.py
+++ b/virtinst/cli.py
@@ -1411,6 +1411,7 @@ def parse_security(guest, security):
     # Beware, adding boolean options here could upset label comma handling
     mode = get_opt_param(opts, "type")
     label = get_opt_param(opts, "label")
+    relabel = yes_or_no_convert(get_opt_param(opts, "relabel"))
 
     # Try to fix up label if it contained commas
     if label:
@@ -1437,6 +1438,9 @@ def parse_security(guest, security):
     if mode:
         secmodel.type = mode
 
+    if relabel:
+        secmodel.relabel = relabel
+
     if opts:
         raise ValueError(_("Unknown options %s") % opts.keys())
 
commit e6a1e4a4ece66187a15af0e5044b8966d9a9b059
Author: Cole Robinson <crobinso@redhat.com>
Date:   Thu Oct 6 13:55:32 2011 -0400

    Fix some issues with relabel= support

diff --git a/tests/cli-test-xml/compare/many-devices.xml b/tests/cli-test-xml/compare/many-devices.xml
index 6b4995d..badedbe 100644
--- a/tests/cli-test-xml/compare/many-devices.xml
+++ b/tests/cli-test-xml/compare/many-devices.xml
@@ -76,7 +76,7 @@
     <smartcard mode='passthrough' type='spicevmc'>
     </smartcard>
   </devices>
-  <seclabel type='static' model='testSecurity'>
+  <seclabel type='static' model='testSecurity' relabel='yes'>
     <label>system_u:object_r:svirt_image_t:s0:c100,c200</label>
   </seclabel>
 </domain>
@@ -157,7 +157,7 @@
     <smartcard mode='passthrough' type='spicevmc'>
     </smartcard>
   </devices>
-  <seclabel type='static' model='testSecurity'>
+  <seclabel type='static' model='testSecurity' relabel='yes'>
     <label>system_u:object_r:svirt_image_t:s0:c100,c200</label>
   </seclabel>
 </domain>
diff --git a/virtinst/Seclabel.py b/virtinst/Seclabel.py
index 2035578..7682664 100644
--- a/virtinst/Seclabel.py
+++ b/virtinst/Seclabel.py
@@ -78,9 +78,9 @@ class Seclabel(XMLBuilderDomain.XMLBuilderDomain):
                           xpath="./seclabel/label")
 
     def _get_relabel(self):
-        return self._label
+        return self._relabel
     def _set_relabel(self, val):
-        self._label = val
+        self._relabel = val
     relabel = _xml_property(_get_relabel, _set_relabel,
                             xpath="./seclabel/@relabel")
 
diff --git a/virtinst/cli.py b/virtinst/cli.py
index a8cd101..457f3f6 100644
--- a/virtinst/cli.py
+++ b/virtinst/cli.py
@@ -526,6 +526,9 @@ def is_prompt():
     return doprompt
 
 def yes_or_no_convert(s):
+    if s is None:
+        return None
+
     s = s.lower()
     if s in ("y", "yes", "1", "true", "t"):
         return True
