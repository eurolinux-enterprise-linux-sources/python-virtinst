From cea50332f8ae438bd2ac66b6324094fdb3d7639f Mon Sep 17 00:00:00 2001
From: Giuseppe Scrivano <gscrivan@redhat.com>
Date: Mon, 5 May 2014 12:26:46 +0200
Subject: [PATCH] support: correctly check the SPICEVMC support on RHEL-6

Closes: https://bugzilla.redhat.com/show_bug.cgi?id=853386

RHEL-only

Signed-off-by: Giuseppe Scrivano <gscrivan@redhat.com>
---
 virtinst/Guest.py   |  3 ++-
 virtinst/support.py | 10 ++++++----
 2 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/virtinst/Guest.py b/virtinst/Guest.py
index 05c36c7..bb79f45 100644
--- a/virtinst/Guest.py
+++ b/virtinst/Guest.py
@@ -1498,7 +1498,8 @@ class Guest(XMLBuilderDomain.XMLBuilderDomain):
         if (has_spice() and
             not has_spice_agent() and
             support.check_conn_support(self.conn,
-                                       support.SUPPORT_CONN_HV_CHAR_SPICEVMC)):
+                                       support.SUPPORT_CONN_HV_CHAR_SPICEVMC,
+                                       self._is_rhel6())):
             agentdev = VirtualCharDevice.get_dev_instance(self.conn,
                                             VirtualCharDevice.DEV_CHANNEL,
                                             VirtualCharDevice.CHAR_SPICEVMC)
diff --git a/virtinst/support.py b/virtinst/support.py
index 2874a90..ee71f33 100644
--- a/virtinst/support.py
+++ b/virtinst/support.py
@@ -391,7 +391,7 @@ def _split_function_name(function):
     else:
         return (output[0], output[1])
 
-def _check_support(conn, feature, data=None):
+def _check_support(conn, feature, data=None, force_rhel6=False):
     """
     Attempt to determine if a specific libvirt feature is support given
     the passed connection.
@@ -403,6 +403,8 @@ def _check_support(conn, feature, data=None):
     @param data: Option libvirt object to use in feature checking
     @type  data: Could be virDomain, virNetwork, virStoragePool,
                 hv name, etc
+    @param force_rhel6: Force to check the support on RHEL-6
+    @type  force_rhel6: bool
 
     @returns: True if feature is supported, False otherwise
     """
@@ -419,7 +421,7 @@ def _check_support(conn, feature, data=None):
 
     uri = conn.getURI()
     drv_type = _util.get_uri_driver(uri)
-    is_rhel6 = _get_rhel6()
+    is_rhel6 = force_rhel6 or _get_rhel6()
     force_version = get_value("force_version") or False
 
     minimum_libvirt_version = get_value("version") or 0
@@ -572,8 +574,8 @@ def support_threading():
 def support_openauth():
     return bool(_local_lib_ver() >= 4000)
 
-def check_conn_support(conn, feature):
-    return _check_support(conn, feature, conn)
+def check_conn_support(conn, feature, force_rhel6=False):
+    return _check_support(conn, feature, conn, force_rhel6=force_rhel6)
 
 def check_conn_hv_support(conn, feature, hv):
     return _check_support(conn, feature, hv)
-- 
1.9.0

